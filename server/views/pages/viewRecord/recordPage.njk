{% extends "../../partials/layout.njk" %}
{% set pageTitle = "View and match learner record â€“ " + applicationName + " - GOV.UK" %}
{% set mainClasses = "govuk-main-wrapper--l" %}
{% if mode == '0' %}
  {% set backLink = backBase + prisoner.prisonerNumber %}
{% endif %}
{% if mode == '1' %}
  {% set backLink = '/find-a-prisoner' %}
{% endif %}

{% block content %}


<div class="govuk-width-container">

  {% if mode == '0' %}
    <h1 class="govuk-heading-l">View and match learner record</h1>
  {% endif %}
  {% if mode == '1' %}
    <h1 class="govuk-heading-l">View learner record</h1>
  {% endif %}

  <p class="govuk-body">Information from Learner Records Service (LRS).</p>

  {% set panelContent %}
    <h2 class="govuk-heading-m" id="uln">ULN: {{ learner.uln }}</h2>
    <div class="govuk-flex">
      <p class="govuk-body govuk-!-margin-right-3" id="givenName">Given name: {{ learner.givenName }}</p>
      <p class="govuk-body govuk-!-margin-right-3" id="familyName">Family name: {{ learner.familyName }}</p>
      <p class="govuk-body govuk-!-margin-right-3" id="dob">Date of birth: {{ learner.dateOfBirth | date}} </p>
    </div>
    <div class="govuk-flex">
      <p class="govuk-body govuk-!-margin-right-3" id="postcode">Postcode: {{ learner.lastKnownPostCode }}</p>
      <p class="govuk-body govuk-!-margin-right-3" id="sex">Sex: {{ learner.gender }}</p>
    </div>
  {% endset %}

  {% if mode == '0' %}
    {{ mojTicketPanel({
      items: [{
        html: panelContent
      }]
    }) }}
  {% endif %}

  {% set tableRows = [] %}
  
  {% for record in learnerEvents %}
    {% set row = [
      { text: record.subject },
      { text: record.awardingOrganisationName },
      { text: record.qualificationType },
      { text: record.level or "Not Specified" },
      { text: record.grade },
      { text: record.achievementAwardDate | date },
      { text: record.source }
    ] %}
    {% set tableRows = (tableRows.push(row), tableRows) %}
  {% endfor %}

  {% if tableRows | length > 0 %}
    {{ govukTable({
      attributes: {
        "data-module": "moj-sortable-table",
        id: "learnerRecordTable"
      },
      head: [
        {
          text: "Subject"
        },
        {
          text: "Awarding body",
          attributes: {
            "aria-sort": "none"
          }
        },
        {
          text: "Qualification Type"
        },
        {
          text: "Level",
          attributes: {
            "aria-sort": "none"
          }
        },
        {
          text: "Grade"
        },
        {
          text: "Awarded on",
          attributes: {
            "aria-sort": "none"
          }
        },
        {
          text: "Source"
        }
      ],
      rows: tableRows
    }) }}
  {% else %}
    <p class="govuk-body">A learning record was found but it is empty.</p>
  {% endif %}

  {% if mode == '0' %}
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-two-thirds">

        <h3 class="govuk-heading-m">Match this learner record to {{ prisoner.firstName }} {{ prisoner.lastName }}</h3>
        <p class="govuk-body">By clicking 'Match record' you will link the following prisoner and learner records:</p>

        {{ govukTable({
          attributes: {
            id: "matchRecordTable"
          },
          head: [
            { text: "Prisoner" },
            { text: "LRS Record"}
          ],
          rows: [
            [
              {
                html: prisoner.firstName + " " + prisoner.lastName  + "<br>Prison number: " + prisoner.prisonerNumber
              },
              {
                html: learner.givenName + " " + learner.familyName  + "<br>ULN: " + learner.uln
              }
            ]
          ]
        }) }}

      </div>
    </div>
  {% endif %}

  <form action="#" method="post">
    <div class="govuk-button-group">
      {% if mode == '0' %}
        {{ govukButton({
          text: "Match record",
          type: "submit",
          id: "matchRecordButton"
        }) }}
      {% endif %}
      <a class="govuk-link" href="{{ backLink }}">Cancel and return to search</a>
      {% if mode == '1' %}
        <a class="govuk-link" href="/">Finish</a>
      {% endif %}
    </div>
    <input type="hidden" name="_csrf" value="{{ csrfToken }}">
    <input type="hidden" name="matchingUln" value="{{ learner.uln }}">
    <input type="hidden" name="givenName" value="{{ learner.givenName }}">
    <input type="hidden" name="familyName" value="{{ learner.familyName }}">
    <input type="hidden" name="matchType" value="{{ matchType }}">
  </form>
</div>

{% endblock %}